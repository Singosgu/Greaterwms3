# TUF元数据文件工作原理详解

## 1. TUF框架概述

TUF（The Update Framework）是一个安全的软件更新框架，它通过元数据签名和验证来确保更新的安全性。即使服务器不进行额外签名，TUF仍然能够通过元数据文件来确定下载哪个文件。

## 2. 元数据文件结构

TUF使用分层的元数据文件结构：

### 2.1 根元数据 (root.json)
- 包含其他元数据文件的密钥信息
- 定义信任链的根证书

### 2.2 时间戳元数据 (timestamp.json)
- 包含快照文件的信息
- 确保客户端获取最新版本的元数据

### 2.3 快照元数据 (snapshot.json)
- 包含targets.json等其他元数据文件的版本信息
- 确保元数据的一致性

### 2.4 目标元数据 (targets.json)
- 包含实际可下载文件的信息
- 包括文件名、哈希值、文件大小等

## 3. 文件比对和下载机制

### 3.1 客户端初始化
当TUF客户端初始化时，它会：
1. 下载root.json建立信任根
2. 获取timestamp.json了解最新快照
3. 下载snapshot.json获取targets.json版本
4. 下载targets.json获取可用目标文件列表

### 3.2 目标文件发现
targets.json文件包含类似以下结构的信息：
```json
{
  "targets": {
    "app-win-1.0.1.exe": {
      "hashes": {
        "sha256": "abc123..."
      },
      "length": 1234567
    }
  }
}
```

### 3.3 文件选择过程
1. 客户端根据当前平台筛选目标文件
2. 比较当前版本与目标版本
3. 选择合适的更新文件进行下载
4. 下载过程中验证文件哈希值确保完整性

## 4. 不同签名场景下的工作方式

### 4.1 服务器不签名的情况
在这种情况下：
- 元数据文件由TUF工具在构建时生成和签名
- 客户端仍然可以验证元数据的完整性
- 通过预共享的公钥验证元数据签名
- 确保下载的文件与元数据描述一致

### 4.2 哈希值验证
每个目标文件在targets.json中都有对应的哈希值：
1. 客户端根据文件名找到对应条目
2. 下载文件后计算其哈希值
3. 与元数据中的哈希值进行比对
4. 如果匹配则接受文件，否则拒绝

## 5. 跨平台更新处理

### 5.1 平台识别
在targets.json中可以通过命名约定区分不同平台：
```json
{
  "targets": {
    "myapp-win-1.0.1.exe": { /* Windows版本 */ }
  }
}
```

### 5.2 客户端平台适配
客户端代码会根据运行环境选择合适的文件：
```python
import platform
current_platform = platform.system().lower()  # 'windows'

# 根据平台选择相应的更新文件
if current_platform == 'windows':
    target_file = 'myapp-win-1.0.1.exe'
else:
    target_file = 'myapp-win-1.0.1.exe'  # 默认为Windows版本
```

## 6. 完整更新流程

1. **元数据生成**：构建时使用tufup等工具生成元数据文件
2. **文件上传**：将更新文件和元数据一起上传到服务器
3. **客户端检查**：定期检查timestamp.json获取更新通知
4. **元数据同步**：下载最新的snapshot.json和targets.json
5. **文件发现**：从targets.json中找到适合当前平台的新版本
6. **文件下载**：下载目标文件并验证哈希值
7. **应用更新**：安装更新并重启应用程序

## 7. 安全特性

即使服务器不进行额外签名，TUF仍然提供以下安全保障：
- **完整性保护**：通过哈希值验证确保文件未被篡改
- **回滚防护**：元数据版本号防止降级攻击
- **快过期**：timestamp.json短期有效期确保及时获取更新
- **委派信任**：分层的信任模型限制潜在损害范围

## 8. 我们的实现细节

在我们的项目中，TUF元数据文件的生成和使用流程如下：

### 8.1 元数据生成
1. 使用tufup库在构建时生成元数据文件
2. 元数据文件包含应用更新包的哈希值和大小信息
3. 所有元数据文件都使用预生成的密钥进行签名

### 8.2 客户端验证
1. 客户端下载元数据文件并验证签名
2. 从targets.json中获取可用更新文件列表
3. 从targets.json中获取可用更新文件列表
4. 下载更新文件并验证其哈希值

### 8.3 跨平台支持
我们为Windows平台生成更新文件：
- Windows: `.zip` 格式的压缩包

客户端会自动选择相应的更新文件进行下载和安装。