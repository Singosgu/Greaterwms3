# TUF元数据文件如何比对下载文件

## 问题解答

用户问："如果服务器不签名，那这个程序生成的元数据文件，如何比对下载哪个文件？"

## 答案

即使服务器不进行额外签名，TUF框架仍然能够通过元数据文件安全地确定和下载正确的更新文件。以下是详细的工作原理：

## 1. 元数据生成过程

在构建时，我们使用tufup工具生成元数据文件：
1. 创建TUF仓库并初始化密钥
2. 将应用程序文件添加到仓库
3. 生成包含文件信息的元数据文件
4. 使用预生成的私钥对元数据进行签名

## 2. 元数据包含的信息

生成的targets.json文件包含以下关键信息：
```json
{
  "targets": {
    "Bomiot-1.1.1.zip": {
      "hashes": {
        "sha256": "a199ea78a5dff1f64b0687a9cfd110856b3b1c1458a698257c1019d765752602"
      },
      "length": 7666779
    }
  }
}
```

## 3. 客户端验证流程

客户端通过以下步骤确保下载正确的文件：

### 3.1 元数据验证
1. 下载root.json并使用预共享的公钥验证签名
2. 获取timestamp.json、snapshot.json和targets.json
3. 验证所有元数据文件的签名和完整性

### 3.2 文件发现
1. 从targets.json中获取可用文件列表
2. 根据平台和版本选择合适的文件
3. 获取文件的预期哈希值和大小

### 3.3 文件下载和验证
1. 下载目标文件
2. 计算下载文件的实际哈希值
3. 将实际哈希值与元数据中的预期哈希值进行比对
4. 验证文件大小是否匹配
5. 只有当哈希值和大小都匹配时才接受文件

## 4. 安全性保障

即使服务器不进行额外签名，TUF仍然提供以下安全保障：
- **完整性保护**：通过哈希值验证确保文件未被篡改
- **身份验证**：通过预共享公钥验证元数据签名
- **回滚防护**：元数据版本号防止降级攻击
- **快过期**：timestamp.json短期有效期确保及时获取更新

## 5. 实际应用示例

在我们的项目中：
1. 构建时生成包含文件哈希值的targets.json
2. 客户端下载targets.json并验证签名
3. 客户端根据平台选择Bomiot-1.1.1.zip文件
4. 下载文件并验证其哈希值为a199ea78a5dff1f64b0687a9cfd110856b3b1c1458a698257c1019d765752602
5. 只有哈希值匹配才安装更新

这种方式确保了即使服务器不进行额外签名，客户端仍然能够安全地确定和下载正确的更新文件。