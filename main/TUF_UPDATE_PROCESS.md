# TUF更新流程详解

## 1. TUF工作原理概述

TUF（The Update Framework）是一个安全的软件更新框架，它通过元数据签名和验证来确保更新的安全性。TUF使用分层的角色签名机制来保护元数据，包括：

- **Root**：定义其他顶层角色的密钥和阈值
- **Timestamp**：提供快照文件的当前版本信息
- **Snapshot**：列出当前targets文件和其他元数据文件的版本
- **Targets**：描述实际的目标文件（应用程序更新包）

## 2. 客户端与服务器交互流程

### 2.1 客户端初始化
1. 客户端首次运行时从服务器下载根元数据（root.json）
2. 验证根元数据的签名
3. 建立信任链

### 2.2 更新检查流程
1. 客户端请求服务器上的timestamp.json文件
2. 根据timestamp中的信息请求snapshot.json
3. 根据snapshot中的信息请求targets.json
4. 比较targets.json中的版本信息与本地版本
5. 如果有新版本，则下载相应的更新包

### 2.3 更新包下载与验证
1. 客户端下载目标文件（更新包）
2. 验证文件的哈希值与targets.json中的描述是否一致
3. 验证文件的数字签名
4. 解压并安装更新

## 3. 服务器端元数据生成流程

### 3.1 初始化仓库
```python
from tufup.repo import Repository

# 创建仓库实例
repo = Repository(
    app_name="Bomiot",
    repo_dir=Path("updates"),
    keys_dir=Path("updates/keys"),
)

# 初始化仓库（创建密钥和初始元数据）
repo.initialize()
```

### 3.2 添加新版本
```python
# 添加新版本到仓库
repo.add_bundle(
    new_bundle_dir=Path("app_1.2.0"),  # 新版本的应用文件目录
    new_version="1.2.0",               # 新版本号
    skip_patch=False                   # 创建补丁文件以支持增量更新
)
```

### 3.3 发布更新
```python
# 发布更新（使用私钥签名元数据）
repo.publish_changes(private_key_dirs=[Path("updates/keys")])
```

## 4. 关于服务器迁移和动态地址更新

### 4.1 动态服务器地址机制
在您的应用中，我们实现了动态服务器地址更新机制：

1. 客户端从更新包中读取新的服务器配置
2. 将新的服务器地址保存到本地配置文件
3. 后续更新使用新的服务器地址

### 4.2 跨平台URL支持
Windows平台可以使用特定的更新服务器URL：
- Windows: `http://3.135.61.8:8008/media/update/win`

## 5. 部署说明

### 5.1 服务器端部署
1. 在服务器上运行元数据生成脚本
2. 将生成的metadata目录内容上传到服务器的metadata路径
3. 将生成的targets目录内容上传到服务器的targets路径
4. 确保文件权限正确设置

### 5.2 客户端行为
1. 客户端定期检查服务器元数据
2. 发现新版本时自动下载更新包
3. 验证更新包完整性后安装更新
4. 支持回滚机制以防更新失败

## 6. 安全性考虑

### 6.1 密钥管理
- 私钥必须安全存储，不能泄露
- 建议使用硬件安全模块(HSM)或密钥管理服务
- 定期轮换密钥

### 6.2 网络传输安全
- 使用HTTPS传输所有元数据和目标文件
- 防止中间人攻击

### 6.3 版本回滚保护
- TUF防止版本回滚攻击
- 客户端拒绝安装比当前版本更旧的更新

## 7. 故障排除

### 7.1 常见问题
1. **元数据验证失败**：检查密钥是否正确，时间是否同步
2. **网络连接问题**：检查服务器地址和网络连接
3. **更新包损坏**：重新生成更新包和元数据

### 7.2 日志查看
查看应用程序日志以获取详细的错误信息和调试信息。