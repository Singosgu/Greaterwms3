name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clean and Initialize TUF Repository (Windows)
      run: |
        python -c "
        import os
        import sys
        import shutil
        from pathlib import Path
        sys.path.insert(0, str(Path.cwd()))
        from main.update_config import APP_NAME, CURRENT_VERSION
        from tufup.repo import Repository
        
        # 定义仓库路径
        REPO_DIR = Path.cwd() / 'updates'
        KEYS_DIR = REPO_DIR / 'keys'
        METADATA_DIR = REPO_DIR / 'metadata'
        TARGETS_DIR = REPO_DIR / 'targets'
        
        # 清理现有的目录（如果存在）
        for directory in [REPO_DIR, KEYS_DIR, METADATA_DIR, TARGETS_DIR]:
            if directory.exists():
                shutil.rmtree(directory)
                print(f'清理目录: {directory}')
        
        # 创建必要的目录
        for directory in [REPO_DIR, KEYS_DIR, METADATA_DIR, TARGETS_DIR]:
            directory.mkdir(parents=True, exist_ok=True)
            print(f'创建目录: {directory}')
        
        # 创建仓库实例
        repo = Repository(
            app_name=APP_NAME or 'Bomiot',
            repo_dir=REPO_DIR,
            keys_dir=KEYS_DIR,
        )
        
        # 初始化仓库
        repo.initialize()
        print('TUF 仓库初始化成功!')
        
        # 创建一个简单的应用目录结构作为示例
        app_dir = REPO_DIR / 'app'
        app_dir.mkdir(exist_ok=True)
        
        # 创建一个简单的应用文件
        app_file = app_dir / 'app.py'
        app_file.write_text(f'# {APP_NAME or \"Bomiot\"} Application\\nprint(\"Hello from {APP_NAME or \"Bomiot\"} version {CURRENT_VERSION or \"1.0.0\"}\")')
        
        # 添加初始版本到仓库
        repo.add_bundle(
            new_bundle_dir=app_dir,
            new_version=CURRENT_VERSION or '1.0.0',
            skip_patch=True  # 跳过补丁创建以简化示例
        )
        
        # 发布更改以生成版本化的元数据文件
        repo.publish_changes(private_key_dirs=[str(KEYS_DIR)])
        print('仓库初始化完成!')
        "
    
    - name: Verify TUF Metadata Files (Windows)
      run: |
        python -c "
        import json
        from pathlib import Path
        
        METADATA_DIR = Path('updates/metadata')
        required_files = [
            'root.json',
            '1.root.json',
            '2.root.json',
            'snapshot.json',
            'targets.json',
            'timestamp.json'
        ]
        
        print('验证生成的元数据文件...')
        missing_files = []
        for filename in required_files:
            file_path = METADATA_DIR / filename
            if file_path.exists():
                print(f'   ✓ {filename} 存在')
            else:
                print(f'   ✗ {filename} 缺失')
                missing_files.append(filename)
        
        if missing_files:
            print(f'缺失文件: {missing_files}')
            exit(1)
        else:
            print('所有必需的元数据文件都已生成!')
        "
    
    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-updates
        path: updates/

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
    
    - name: Clean and Initialize TUF Repository (macOS)
      run: |
        python3 -c "
        import os
        import sys
        import shutil
        from pathlib import Path
        sys.path.insert(0, str(Path.cwd()))
        from main.update_config import APP_NAME, CURRENT_VERSION
        from tufup.repo import Repository
        
        # 定义仓库路径
        REPO_DIR = Path.cwd() / 'updates'
        KEYS_DIR = REPO_DIR / 'keys'
        METADATA_DIR = REPO_DIR / 'metadata'
        TARGETS_DIR = REPO_DIR / 'targets'
        
        # 清理现有的目录（如果存在）
        for directory in [REPO_DIR, KEYS_DIR, METADATA_DIR, TARGETS_DIR]:
            if directory.exists():
                shutil.rmtree(directory)
                print(f'清理目录: {directory}')
        
        # 创建必要的目录
        for directory in [REPO_DIR, KEYS_DIR, METADATA_DIR, TARGETS_DIR]:
            directory.mkdir(parents=True, exist_ok=True)
            print(f'创建目录: {directory}')
        
        # 创建仓库实例
        repo = Repository(
            app_name=APP_NAME or 'Bomiot',
            repo_dir=REPO_DIR,
            keys_dir=KEYS_DIR,
        )
        
        # 初始化仓库
        repo.initialize()
        print('TUF 仓库初始化成功!')
        
        # 创建一个简单的应用目录结构作为示例
        app_dir = REPO_DIR / 'app'
        app_dir.mkdir(exist_ok=True)
        
        # 创建一个简单的应用文件
        app_file = app_dir / 'app.py'
        app_file.write_text(f'# {APP_NAME or \"Bomiot\"} Application\\nprint(\"Hello from {APP_NAME or \"Bomiot\"} version {CURRENT_VERSION or \"1.0.0\"}\")')
        
        # 添加初始版本到仓库
        repo.add_bundle(
            new_bundle_dir=app_dir,
            new_version=CURRENT_VERSION or '1.0.0',
            skip_patch=True  # 跳过补丁创建以简化示例
        )
        
        # 发布更改以生成版本化的元数据文件
        repo.publish_changes(private_key_dirs=[str(KEYS_DIR)])
        print('仓库初始化完成!')
        "
    
    - name: Verify TUF Metadata Files (macOS)
      run: |
        python3 -c "
        import json
        from pathlib import Path
        
        METADATA_DIR = Path('updates/metadata')
        required_files = [
            'root.json',
            '1.root.json',
            '2.root.json',
            'snapshot.json',
            'targets.json',
            'timestamp.json'
        ]
        
        print('验证生成的元数据文件...')
        missing_files = []
        for filename in required_files:
            file_path = METADATA_DIR / filename
            if file_path.exists():
                print(f'   ✓ {filename} 存在')
            else:
                print(f'   ✗ {filename} 缺失')
                missing_files.append(filename)
        
        if missing_files:
            print(f'缺失文件: {missing_files}')
            exit(1)
        else:
            print('所有必需的元数据文件都已生成!')
        "
    
    - name: Upload macOS Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: macos-updates
        path: updates/

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
    
    - name: Clean and Initialize TUF Repository (Linux)
      run: |
        python3 -c "
        import os
        import sys
        import shutil
        from pathlib import Path
        sys.path.insert(0, str(Path.cwd()))
        from main.update_config import APP_NAME, CURRENT_VERSION
        from tufup.repo import Repository
        
        # 定义仓库路径
        REPO_DIR = Path.cwd() / 'updates'
        KEYS_DIR = REPO_DIR / 'keys'
        METADATA_DIR = REPO_DIR / 'metadata'
        TARGETS_DIR = REPO_DIR / 'targets'
        
        # 清理现有的目录（如果存在）
        for directory in [REPO_DIR, KEYS_DIR, METADATA_DIR, TARGETS_DIR]:
            if directory.exists():
                shutil.rmtree(directory)
                print(f'清理目录: {directory}')
        
        # 创建必要的目录
        for directory in [REPO_DIR, KEYS_DIR, METADATA_DIR, TARGETS_DIR]:
            directory.mkdir(parents=True, exist_ok=True)
            print(f'创建目录: {directory}')
        
        # 创建仓库实例
        repo = Repository(
            app_name=APP_NAME or 'Bomiot',
            repo_dir=REPO_DIR,
            keys_dir=KEYS_DIR,
        )
        
        # 初始化仓库
        repo.initialize()
        print('TUF 仓库初始化成功!')
        
        # 创建一个简单的应用目录结构作为示例
        app_dir = REPO_DIR / 'app'
        app_dir.mkdir(exist_ok=True)
        
        # 创建一个简单的应用文件
        app_file = app_dir / 'app.py'
        app_file.write_text(f'# {APP_NAME or \"Bomiot\"} Application\\nprint(\"Hello from {APP_NAME or \"Bomiot\"} version {CURRENT_VERSION or \"1.0.0\"}\")')
        
        # 添加初始版本到仓库
        repo.add_bundle(
            new_bundle_dir=app_dir,
            new_version=CURRENT_VERSION or '1.0.0',
            skip_patch=True  # 跳过补丁创建以简化示例
        )
        
        # 发布更改以生成版本化的元数据文件
        repo.publish_changes(private_key_dirs=[str(KEYS_DIR)])
        print('仓库初始化完成!')
        "
    
    - name: Verify TUF Metadata Files (Linux)
      run: |
        python3 -c "
        import json
        from pathlib import Path
        
        METADATA_DIR = Path('updates/metadata')
        required_files = [
            'root.json',
            '1.root.json',
            '2.root.json',
            'snapshot.json',
            'targets.json',
            'timestamp.json'
        ]
        
        print('验证生成的元数据文件...')
        missing_files = []
        for filename in required_files:
            file_path = METADATA_DIR / filename
            if file_path.exists():
                print(f'   ✓ {filename} 存在')
            else:
                print(f'   ✗ {filename} 缺失')
                missing_files.append(filename)
        
        if missing_files:
            print(f'缺失文件: {missing_files}')
            exit(1)
        else:
            print('所有必需的元数据文件都已生成!')
        "
    
    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: linux-updates
        path: updates/

  deploy:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
    - name: Download Windows Artifacts
      uses: actions/download-artifact@v3
      with:
        name: windows-updates
        path: updates/windows
    
    - name: Download macOS Artifacts
      uses: actions/download-artifact@v3
      with:
        name: macos-updates
        path: updates/macos
    
    - name: Download Linux Artifacts
      uses: actions/download-artifact@v3
      with:
        name: linux-updates
        path: updates/linux
    
    - name: Deploy to Server
      run: |
        echo "部署更新文件到服务器..."
        # 这里添加部署到服务器的命令
        # 例如使用 rsync, scp 或其他部署工具
        echo "部署完成!"